<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard | AI Test Case Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="shortcut icon" href="/static/assets/images/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- DateRangePicker CSS and JS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <style>

        
        /* Analytics Dashboard Styles */
        .analytics-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .analytics-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 170, 114, 0.15);
            border-color: #4CAA72;
        }

        .analytics-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #4CAA72, #3d8a5e);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .analytics-card:hover .analytics-icon {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(76, 170, 114, 0.3);
        }

        .analytics-icon i {
            color: white;
            font-size: 20px;
        }

        .analytics-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .analytics-number {
            font-size: 28px;
            font-weight: 700;
            color: #041E2B;
            margin-bottom: 5px;
            line-height: 1;
        }

        .analytics-label {
            font-size: 12px;
            color: rgba(4, 30, 43, 0.6);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
            min-height: 320px;
            display: flex;
            flex-direction: column;
        }
        
        .chart-container.compact {
            min-height: 150px;
        }
        
        .chart-container h5 {
            color: #333;
            font-weight: 500;
            margin-bottom: 15px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .chart-container h5 i {
            color: #666;
            font-size: 1rem;
        }
        
        .chart-container canvas {
            width: 100%;
            height: auto;
            flex: 1;
            max-height: 280px;
            cursor: default; /* charts themselves are not clickable */
        }
        
        .chart-container .chart-placeholder {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-style: italic;
            min-height: 200px;
        }
        
        /* Chart Legend Styles */
        .chartjs-legend-item {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .chartjs-legend-item:hover {
            opacity: 0.8;
        }
        
        /* Make chart legends clickable with hand cursor */
        .chart-container .chartjs-legend {
            cursor: pointer;
        }
        
        .chart-container .chartjs-legend li {
            cursor: pointer;
        }
        
        /* Chart drawing area should use default cursor (not clickable) */
        .chart-container .chartjs-chart {
            cursor: default;
        }
        
        .chart-container .loading-message,
        .chart-container .no-data-message {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            text-align: center;
            color: #666;
        }
        
        .chart-container .loading-message i,
        .chart-container .no-data-message i {
            margin-right: 8px;
            font-size: 1.2em;
        }
        
        .chart-container .loading-message {
            color: #4CAA72;
        }
        
        .chart-container .no-data-message {
            color: #6c757d;
        }
        
        .chart-container .loading-placeholder {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }
        
        /* Button loading state styles */
        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .btn-loading {
            background-color: #4CAA72 !important;
            border-color: #4CAA72 !important;
            opacity: 0.8;
        }
        
        .btn-secondary {
            background-color: #6c757d !important;
            border-color: #6c757d !important;
        }
        
        /* Back to Top Button */
        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background-color: #4cab72;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(76, 171, 114, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .back-to-top:hover {
            background-color: #3a8a5f;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(76, 171, 114, 0.4);
        }
        
        .back-to-top.show {
            display: flex;
        }
        
        @media (max-width: 768px) {
            .back-to-top {
                bottom: 20px;
                right: 20px;
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
        }
        
        /* Smart Search Styles */
        .smart-search-container {
            position: relative;
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }
        
        .smart-search-input-container {
            position: relative;
            flex: 1;
        }
        
        .clear-btn {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
            background: none;
            border: none;
            color: #6c757d;
            padding: 0;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            line-height: 1;
            transition: color 0.2s ease;
            outline: none;
        }
        
        .clear-btn:hover {
            color: #4CAA72;
        }
        
        .clear-btn:focus {
            outline: none;
            box-shadow: none;
        }
        
        .smart-search-input-container input {
            padding-right: 30px;
        }
        
        .smart-search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ced4da;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .smart-search-option {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .smart-search-option:last-child {
            border-bottom: none;
        }
        
        .smart-search-option:hover {
            background-color: #f8f9fa;
        }
        
        .smart-search-option.selected {
            background-color: #4CAA72;
            color: white;
        }
        
        .smart-search-option.highlighted {
            background-color: #e9ecef;
        }
        
        .smart-search-option.hidden {
            display: none;
        }
        
        #clearSourceBtn {
            white-space: nowrap;
            height: 38px;
        }
        .filter-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .activity-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #4CAA72;
        }
        .header {
            background: white;
            color: #333;
            padding: 35px 0;
            margin-bottom: 30px;
            border-radius: 10px;
            margin: 20px;
            position: relative;
        }
        
        .header-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            width: 100%;
            z-index: 1;
            pointer-events: none;
        }
        
        .header .btn-light {
            position: relative;
            z-index: 10;
            pointer-events: auto;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                padding: 15px 0;
                margin: 10px;
            }
            
            .header-center {
                position: static;
                transform: none;
                pointer-events: auto;
                margin: 10px 0;
            }
            
            .header-center h1 {
                font-size: 1.5rem;
            }
            
            .header-center p {
                font-size: 0.9rem;
            }
            
            .header img {
                height: 25px;
            }
            
            .header .btn-light {
                font-size: 12px;
                padding: 6px 12px;
            }
            
            .filter-section .row {
                flex-direction: column;
            }
            
            .filter-section .col-md-3 {
                margin-bottom: 15px;
            }
            
            .analytics-card {
                margin-bottom: 15px;
            }
            
            .chart-container {
                min-height: 250px;
            }
            
            /* Show only 1 analytics card per row on mobile */
            .col-md-2 {
                flex: 0 0 100%;
                max-width: 100%;
                margin-bottom: 15px;
            }
        }
        
        @media (max-width: 576px) {
            .header-center h1 {
                font-size: 1.2rem;
            }
            
            .header-center p {
                font-size: 0.8rem;
            }
            
            .header .btn-light {
                font-size: 11px;
                padding: 5px 10px;
            }
            
            .analytics-number {
                font-size: 20px;
            }
            
            .analytics-label {
                font-size: 10px;
            }
            
            .smart-search-dropdown {
                max-height: 150px;
            }
            
            .smart-search-option {
                padding: 8px 10px;
                font-size: 14px;
            }
            
            .clear-btn {
                width: 16px;
                height: 16px;
                font-size: 14px;
            }
            
            /* Additional mobile improvements for analytics cards */
            .analytics-card {
                padding: 15px;
                margin-bottom: 10px;
            }
            
            .analytics-icon {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            
            .analytics-content {
                margin-left: 12px;
            }
        }
        
        .header img {
            height: 35px;
            margin-right: 15px;
        }
        
        .header h1 {
            color: #333;
            font-size: 2.2rem;
            font-weight: 700;
            margin: 0;
            align-items: center;
        }
        
        .header h1 i {
            margin-right: 10px;
            font-size: 1.8rem;
            color: #4CAA72;
        }
        
        .header p {
            color: #666;
            font-size: 1rem;
            margin: 5px 0 0 0;
        }
        
        .header .btn-light {
            background-color: rgb(76, 171, 114);
            border: 1px solid rgb(76, 171, 114);
            color: white;
            padding: 8px 22px;
            font-size: 14px;
            border-radius: 4px;
            transition: all 0.3s ease;
            text-decoration: none;
            box-shadow: 0 14px 26px -12px rgba(76, 171, 114, 0.42), 0 4px 23px 0 rgba(0, 0, 0, 0.12), 0 8px 10px -5px rgba(76, 171, 114, 0.20);
        }
        
        .header .btn-light:hover,
        .header .btn-light:focus {
            background-color: rgba(76, 171, 114, 0.1);
            border-color: rgb(76, 171, 114);
            box-shadow: none;
            color: rgb(76, 171, 114);
            text-decoration: none;
        }
        
        /* Brand green button styling */
        .btn-primary {
            background-color: rgb(76, 171, 114);
            border: 1px solid rgb(76, 171, 114);
            padding: 8px 22px;
            border-radius: 4px;
            font-size: 14px;
            box-shadow: 0 14px 26px -12px rgba(76, 171, 114, 0.42), 0 4px 23px 0 rgba(0, 0, 0, 0.12), 0 8px 10px -5px rgba(76, 171, 114, 0.20);
        }
        
        .btn-primary:hover,
        .btn-primary:focus {
            background-color: rgba(76, 171, 114, 0.1);
            border-color: rgb(76, 171, 114);
            box-shadow: none;
            color: rgb(76, 171, 114);
        }
        
        .btn:focus {
            box-shadow: none !important;
        }
        /* DateRangePicker Custom Styles */
        .daterangepicker {
            border: 1px solid #ced4da;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .daterangepicker .ranges li {
            border-radius: 4px;
            margin: 2px 0;
        }
        
        .daterangepicker .ranges li:hover {
            background-color: #4CAA72;
            color: white;
        }
        
        .daterangepicker .ranges li.active {
            background-color: #4CAA72;
            color: white;
        }
        
        .daterangepicker td.active, .daterangepicker td.active:hover {
            background-color: #4CAA72;
        }
        
        .daterangepicker td.in-range {
            background-color: rgba(76, 170, 114, 0.2);
        }

        /* Navbar styles */
        .navbar {
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 1rem 0;
        }

        .navbar-brand {
            font-weight: 700;
            color: #4CAA72 !important;
            font-size: 1.5rem;
        }

        .navbar-nav .nav-link {
            color: #1f2937;
            font-weight: 500;
            margin: 0 0.5rem;
            transition: color 0.3s ease;
        }

        .navbar-nav .nav-link:hover {
            color: #4CAA72;
        }

        .navbar-toggler {
            border: none;
            padding: 0.25rem 0.5rem;
        }

        .navbar-toggler:focus {
            box-shadow: none;
        }

        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%2833, 37, 41, 0.75%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }

        @media (max-width: 768px) {
            .navbar-brand {
                font-size: 1.25rem;
            }
            
            .navbar-nav {
                text-align: center;
                padding: 1rem 0;
            }
            
            .navbar-nav .nav-link {
                padding: 0.75rem 1rem;
                margin: 0.25rem 0;
            }
            
            .user-info {
                justify-content: center;
                margin-top: 0.5rem;
            }
            
            .user-dropdown {
                justify-content: center;
            }
            
            .dropdown-menu {
                position: static !important;
                transform: none !important;
                box-shadow: none;
                border: 1px solid var(--border-color);
                margin-top: 0.5rem;
            }
        }

        /* User Dropdown Styles */
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        .user-dropdown {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.2s ease;
            user-select: none;
        }

        .user-dropdown:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: #4CAA72;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .user-name {
            color: #495057;
            font-weight: 500;
            font-size: 14px;
        }

        .dropdown-arrow {
            color: #6c757d;
            font-size: 12px;
            transition: transform 0.2s ease;
        }

        .user-dropdown.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 160px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            margin-top: 8px;
        }

        .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: block;
            padding: 12px 16px;
            color: #495057;
            text-decoration: none;
            transition: background-color 0.2s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
            color: #212529;
        }

        .dropdown-divider {
            height: 1px;
            background-color: #e9ecef;
            margin: 4px 0;
        }
    </style>
</head>
<body>
    <!-- Back to Top Button -->
    <button class="back-to-top" id="backToTop" title="Back to Top">
        <i class="bi bi-arrow-up"></i>
    </button>

    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-robot me-2"></i>
                <span class="d-none d-sm-inline">AI Test Case Generator</span>
                <span class="d-inline d-sm-none">AI Test Case</span>
            </a>
            
            <!-- Mobile toggle button -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <!-- Collapsible navbar content -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Home</a>
                <a class="nav-link" href="/documentation">Documentation</a>
                <a class="nav-link" href="/signin" id="signinNavLink">Sign In</a>
                <!-- <a class="nav-link" href="/dashboard" id="dashboardNavLink" style="display: none;">Dashboard</a> -->
                <a class="nav-link active" href="/analytics" id="analyticsNavLink" style="display: none;">Analytics</a>
                <div class="user-info" id="userInfoNav" style="display: none;">
                    <div class="user-dropdown" onclick="toggleUserDropdown()">
                        <div class="user-avatar" id="userAvatar">
                            <i class="bi bi-person"></i>
                        </div>
                        <span class="user-name d-none d-md-inline" id="userName">User</span>
                        <i class="bi bi-chevron-down dropdown-arrow"></i>
                    </div>
                    <div class="dropdown-menu" id="userDropdownMenu">
                        <a href="/dashboard" class="dropdown-item">
                            <i class="bi bi-speedometer2 me-2"></i>Dashboard
                        </a>
                        <a href="/admin-dashboard" class="dropdown-item" id="adminDashboardLink" style="display: none;">
                            <i class="bi bi-shield-check me-2"></i>Admin Dashboard
                        </a>
                        <div class="dropdown-divider"></div>
                        <button class="dropdown-item" onclick="logout()">
                            <i class="bi bi-box-arrow-right me-2"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </nav>

    <div class="header">
        
        
        <!-- Centered title and subtitle -->
        <div class="header-center">
            <h1><i class="bi bi-graph-up"></i> Analytics Dashboard</h1>
            <p class="mb-0">AI Test Case Generator Usage Analytics</p>
        </div>
    </div>

    <div class="container">
        <!-- Filter Section -->
        <div class="filter-section">
            <div class="row justify-content-center align-items-end">
                <div class="col-md-3">
                    <label class="form-label">Time Period</label>
                    <div class="input-group">
                        <input type="text" name="daterange" id="daterange" class="form-control" value="01/01/2018 - 01/15/2018" />
                        <span class="input-group-text" id="calendarIcon" style="cursor: pointer;">
                            <i class="bi bi-calendar3"></i>
                        </span>
                    </div>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Source Type</label>
                    <div class="smart-search-container">
                        <div class="smart-search-input-container">
                            <input type="text" class="form-control" id="sourceTypeSearch" placeholder="Search source types..." autocomplete="off">
                            <button type="button" class="btn btn-link btn-sm clear-btn" id="clearSourceBtn" style="display: none;">
                                <i class="bi bi-x"></i>
                            </button>
                            <div class="smart-search-dropdown" id="sourceTypeDropdown" style="display: none;">
                                <div class="smart-search-option" data-value="jira">
                                    <i class="bi bi-kanban"></i> Jira
                                </div>
                                <div class="smart-search-option" data-value="azure">
                                    <i class="bi bi-grid-3x3-gap"></i> Azure DevOps
                                </div>
                                <div class="smart-search-option" data-value="url">
                                    <i class="bi bi-link-45deg"></i> URL
                                </div>
                                <div class="smart-search-option" data-value="image">
                                    <i class="bi bi-image"></i> Image
                                </div>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="sourceType" value="">
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-primary w-100" onclick="loadAnalytics()">
                        <i class="bi bi-search"></i> Load Analytics
                    </button>
                </div>
            </div>
        </div>

        <!-- Summary Stats -->
        <div class="row mb-5" id="summaryStats">
            <div class="col-md-2">
                <div class="analytics-card">
                    <div class="analytics-icon"><i class="bi bi-graph-up"></i></div>
                    <div class="analytics-content">
                        <div class="analytics-number" id="totalSessions">-</div>
                        <div class="analytics-label">Total Sessions</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="analytics-card">
                    <div class="analytics-icon"><i class="bi bi-play-circle"></i></div>
                    <div class="analytics-content">
                        <div class="analytics-number" id="generateClicks">-</div>
                        <div class="analytics-label">Generate Clicks</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="analytics-card">
                    <div class="analytics-icon"><i class="bi bi-check-circle"></i></div>
                    <div class="analytics-content">
                        <div class="analytics-number" id="successfulGenerations">-</div>
                        <div class="analytics-label">Successful Generations</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="analytics-card">
                    <div class="analytics-icon"><i class="bi bi-percent"></i></div>
                    <div class="analytics-content">
                        <div class="analytics-number" id="successRate">-</div>
                        <div class="analytics-label">Success Rate (%)</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="analytics-card">
                    <div class="analytics-icon"><i class="bi bi-clock"></i></div>
                    <div class="analytics-content">
                        <div class="analytics-number" id="avgGenerationTime">-</div>
                        <div class="analytics-label">Avg Generation Time (s)</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="analytics-card">
                    <div class="analytics-icon"><i class="bi bi-clock-history"></i></div>
                    <div class="analytics-content">
                        <div class="analytics-number" id="maxGenerationTime">-</div>
                        <div class="analytics-label">Max Generation Time (s)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Cases Summary Stats -->
        <div class="row mb-5" id="testCasesStats">
            <div class="col-md-2">
                <div class="analytics-card">
                    <div class="analytics-icon"><i class="bi bi-file-earmark-text"></i></div>
                    <div class="analytics-content">
                        <div class="analytics-number" id="totalTestCases">-</div>
                        <div class="analytics-label">Total Test Cases Generated</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="analytics-card">
                    <div class="analytics-icon"><i class="bi bi-kanban"></i></div>
                    <div class="analytics-content">
                        <div class="analytics-number" id="jiraTestCases">-</div>
                        <div class="analytics-label">Jira Test Cases</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="analytics-card">
                    <div class="analytics-icon"><i class="bi bi-microsoft"></i></div>
                    <div class="analytics-content">
                        <div class="analytics-number" id="azureTestCases">-</div>
                        <div class="analytics-label">Azure Test Cases</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="analytics-card">
                    <div class="analytics-icon"><i class="bi bi-image"></i></div>
                    <div class="analytics-content">
                        <div class="analytics-number" id="imageTestCases">-</div>
                        <div class="analytics-label">Image Test Cases</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="analytics-card">
                    <div class="analytics-icon"><i class="bi bi-link-45deg"></i></div>
                    <div class="analytics-content">
                        <div class="analytics-number" id="urlTestCases">-</div>
                        <div class="analytics-label">URL Test Cases</div>
                    </div>
                </div>
            </div>

        </div>

                 <!-- Error Analytics Section (admin only) -->
         <div class="row mb-5 admin-only" id="errorStats" style="display: none;">
            <div class="col-md-12">
                <h4 class="mb-3"><i class="bi bi-exclamation-triangle"></i> Error Analytics</h4>
            </div>
            <div class="col-md-2">
                <div class="analytics-card">
                    <div class="analytics-icon" style="background: linear-gradient(135deg, #dc3545, #c82333);"><i class="bi bi-exclamation-circle"></i></div>
                    <div class="analytics-content">
                        <div class="analytics-number" id="totalErrors">-</div>
                        <div class="analytics-label">Total Errors</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="analytics-card">
                    <div class="analytics-icon" style="background: linear-gradient(135deg, #ffc107, #e0a800);"><i class="bi bi-exclamation-triangle"></i></div>
                    <div class="analytics-content">
                        <div class="analytics-number" id="warningErrors">-</div>
                        <div class="analytics-label">Warning Errors</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="analytics-card">
                    <div class="analytics-icon" style="background: linear-gradient(135deg, #dc3545, #c82333);"><i class="bi bi-x-circle"></i></div>
                    <div class="analytics-content">
                        <div class="analytics-number" id="criticalErrors">-</div>
                        <div class="analytics-label">Critical Errors</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="analytics-card">
                    <div class="analytics-icon" style="background: linear-gradient(135deg, #6c757d, #5a6268);"><i class="bi bi-info-circle"></i></div>
                    <div class="analytics-content">
                        <div class="analytics-number" id="infoErrors">-</div>
                        <div class="analytics-label">Info Messages</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="analytics-card">
                    <div class="analytics-icon" style="background: linear-gradient(135deg, #17a2b8, #138496);"><i class="bi bi-bug"></i></div>
                    <div class="analytics-content">
                        <div class="analytics-number" id="exceptionErrors">-</div>
                        <div class="analytics-label">Exceptions</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="analytics-card">
                    <div class="analytics-icon" style="background: linear-gradient(135deg, #28a745, #1e7e34);"><i class="bi bi-check-circle"></i></div>
                    <div class="analytics-content">
                        <div class="analytics-number" id="messageErrors">-</div>
                        <div class="analytics-label">Messages</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="bi bi-pie-chart"></i> Source Type Distribution</h5>
                    <canvas id="sourceTypeChart"></canvas>
                    <div class="chart-placeholder" id="sourceTypePlaceholder" style="display: none;">
                        <div class="no-data-message">
                            <i class="bi bi-pie-chart"></i> No source type data available
                        </div>
                    </div>
                    <div class="loading-placeholder" id="sourceTypeLoading" style="display: none;">
                        <div class="loading-message">
                            <i class="bi bi-hourglass-split"></i> Loading source type data...
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="bi bi-bar-chart"></i> Test Case Type Usage</h5>
                    <canvas id="testCaseTypeChart"></canvas>
                    <div class="chart-placeholder" id="testCaseTypePlaceholder" style="display: none;">
                        <div class="no-data-message">
                            <i class="bi bi-bar-chart"></i> No test case type data available
                        </div>
                    </div>
                    <div class="loading-placeholder" id="testCaseTypeLoading" style="display: none;">
                        <div class="loading-message">
                            <i class="bi bi-hourglass-split"></i> Loading test case type data...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="bi bi-graph-up"></i> Daily Activity</h5>
                    <canvas id="dailyActivityChart"></canvas>
                    <div class="chart-placeholder" id="dailyActivityPlaceholder" style="display: none;">
                        <i class="bi bi-graph-up"></i> No daily activity data available
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="bi bi-clock"></i> Generation Time by Source Type</h5>
                    <canvas id="timingBySourceChart"></canvas>
                    <div class="chart-placeholder" id="timingBySourcePlaceholder" style="display: none;">
                        <i class="bi bi-clock"></i> No generation time data by source type available
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12">
                <div class="chart-container">
                    <h5><i class="bi bi-speedometer2"></i> Generation Time by Item Count</h5>
                    <canvas id="timingByItemsChart"></canvas>
                    <div class="chart-placeholder" id="timingByItemsPlaceholder" style="display: none;">
                        <i class="bi bi-speedometer2"></i> No generation time data by item count available
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Charts (admin only) -->
        <div class="row admin-only" style="display: none;">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="bi bi-pie-chart"></i> Error Level Distribution</h5>
                    <canvas id="errorLevelChart"></canvas>
                    <div class="chart-placeholder" id="errorLevelPlaceholder" style="display: none;">
                        <div class="no-data-message">
                            <i class="bi bi-pie-chart"></i> No error level data available
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="bi bi-bar-chart"></i> Error Type Distribution</h5>
                    <canvas id="errorTypeChart"></canvas>
                    <div class="chart-placeholder" id="errorTypePlaceholder" style="display: none;">
                        <div class="no-data-message">
                            <i class="bi bi-bar-chart"></i> No error type data available
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row admin-only" style="display: none;">
            <div class="col-md-12">
                <div class="chart-container">
                    <h5><i class="bi bi-exclamation-triangle"></i> Recent Errors</h5>
                    <div id="recentErrors">
                        <div class="loading-message">
                            <i class="bi bi-hourglass-split"></i> Loading recent errors...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="row">
            <div class="col-md-12">
                <div class="chart-container">
                    <h5><i class="bi bi-clock-history"></i> Recent Activity</h5>
                    <div id="recentActivity">
                        <div class="loading-message">
                            <i class="bi bi-hourglass-split"></i> Loading recent activity...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let sourceTypeChart, testCaseTypeChart, dailyActivityChart, timingBySourceChart, timingByItemsChart;
        let isAdmin = false;
        
        // Date Range Picker Variables
        let selectedStartDate = null;
        let selectedEndDate = null;
        
        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
        });
        
        function checkAuth() {
            const token = localStorage.getItem('authToken');
            const userInfo = localStorage.getItem('userInfo');
            
            console.log('Auth check - Token:', token ? 'exists' : 'missing', 'UserInfo:', userInfo ? 'exists' : 'missing');
            
            // Check if we have at least a token
            if (!token) {
                console.log('No auth token found - redirecting to signin');
                window.location.href = '/signin';
                return;
            }
            
            // If we have a token but no userInfo, create a basic user object and continue
            if (!userInfo) {
                console.log('No userInfo found, but token exists - creating basic user object');
                const basicUser = {
                    name: 'User',
                    email: '',
                    role: 'user'
                };
                localStorage.setItem('userInfo', JSON.stringify(basicUser));
                proceedWithAuth(basicUser);
                return;
            }
            
            // If we have both token and userInfo, proceed with authentication
            try {
                const user = JSON.parse(userInfo);
                proceedWithAuth(user);
            } catch (error) {
                console.error('Error parsing user info:', error);
                // Create a basic user object and continue
                const basicUser = {
                    name: 'User',
                    email: '',
                    role: 'user'
                };
                localStorage.setItem('userInfo', JSON.stringify(basicUser));
                proceedWithAuth(basicUser);
            }
        }
        
        function proceedWithAuth(user) {
            try {
                console.log('User authenticated:', user.name, 'Role:', user.role);
                console.log('Full user info:', user);
                isAdmin = (user.role === 'admin');
                console.log('IsAdmin set to:', isAdmin);
                
                // Update navbar visibility - using the same pattern as index.html
                const signinNavLink = document.getElementById('signinNavLink');
                const dashboardNavLink = document.getElementById('dashboardNavLink');
                const analyticsNavLink = document.getElementById('analyticsNavLink');
                const userInfoNav = document.getElementById('userInfoNav');
                
                if (signinNavLink) signinNavLink.style.display = 'none';
                if (dashboardNavLink) dashboardNavLink.style.display = 'inline-block';
                if (analyticsNavLink) analyticsNavLink.style.display = 'inline-block';
                if (userInfoNav) {
                    userInfoNav.style.display = 'flex';
                    document.getElementById('userName').textContent = user.name;
                    document.getElementById('userAvatar').textContent = user.name.charAt(0).toUpperCase();
                }
                
                // Show admin dashboard link for admin users
                if (user.role === 'admin') {
                    document.getElementById('adminDashboardLink').style.display = 'block';
                }
                
                // Update page title to show user info
                const pageTitle = document.querySelector('h1');
                if (pageTitle && user.role === 'admin') {
                    pageTitle.innerHTML += ' <small class="text-muted">(Admin View)</small>';
                } else if (pageTitle) {
                    pageTitle.innerHTML += ' <small class="text-muted">(User View)</small>';
                }
                
                // Initialize page after authentication check
                initializePage();
                // Track a session view so user tiles (sessions) populate
                trackSessionView();
                
                // Toggle admin-only UI visibility (error analytics etc.)
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.style.display = isAdmin ? '' : 'none';
                });
                
                // For regular users, show fallback recent activity immediately
                if (!isAdmin) {
                    updateRecentActivityFallback();
                } else {
                    // For admin users, also show fallback if no detailed analytics
                    setTimeout(() => {
                        const recentActivity = document.getElementById('recentActivity');
                        if (recentActivity && recentActivity.innerHTML.includes('Loading...')) {
                            updateRecentActivityFallback();
                        }
                    }, 5000); // Fallback after 5 seconds if still loading
                }
            } catch (error) {
                console.error('Error in proceedWithAuth:', error);
                // Clear invalid data and redirect
                localStorage.removeItem('authToken');
                localStorage.removeItem('userInfo');
                window.location.href = '/signin';
            }
        }
        
        // Function to toggle user dropdown
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdownMenu');
            const userDropdown = document.querySelector('.user-dropdown');
            
            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
                userDropdown.classList.remove('active');
            } else {
                dropdown.classList.add('show');
                userDropdown.classList.add('active');
            }
        }

        // Function to close user dropdown
        function closeUserDropdown() {
            const dropdown = document.getElementById('userDropdownMenu');
            const userDropdown = document.querySelector('.user-dropdown');
            
            dropdown.classList.remove('show');
            userDropdown.classList.remove('active');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userInfo = document.getElementById('userInfo');
            const dropdown = document.getElementById('userDropdownMenu');
            
            if (userInfo && !userInfo.contains(event.target)) {
                closeUserDropdown();
            }
        });

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userInfo');
            window.location.href = '/';
        }
        
        // Helper function to get auth headers
        function getAuthHeaders() {
            const token = localStorage.getItem('authToken');
            console.log('Getting auth headers with token:', token ? token.substring(0, 20) + '...' : 'null');
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }
        
        function initializePage() {
            // Set default dates (last 30 days)
            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);
            
            // Format dates for daterangepicker
            const startDateStr = thirtyDaysAgo.toLocaleDateString('en-US', { 
                month: '2-digit', 
                    day: '2-digit', 
                    year: 'numeric' 
                });
            const endDateStr = today.toLocaleDateString('en-US', { 
                month: '2-digit', 
                    day: '2-digit', 
                    year: 'numeric' 
                });
                
            // Set initial value
            document.getElementById('daterange').value = `${startDateStr} - ${endDateStr}`;
            
            // Initialize daterangepicker
            initializeDateRangePicker();
            
            // Initialize smart search
            initializeSmartSearch();
            
            loadAnalytics();
        }

        // Track a session/page visit for analytics (user and admin)
        async function trackSessionView() {
            try {
                const sessionId = localStorage.getItem('sessionId') || (Date.now().toString(36) + Math.random().toString(36).slice(2));
                localStorage.setItem('sessionId', sessionId);
                await fetch('/api/analytics/session', {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        page_visited: 'analytics'
                    })
                });
            } catch (e) {
                console.warn('Session tracking failed:', e.message);
            }
        }

        function showLoadingState() {
            // Show loading for summary stats
            document.getElementById('totalSessions').textContent = '-';
            document.getElementById('generateClicks').textContent = '-';
            document.getElementById('successfulGenerations').textContent = '-';
            document.getElementById('successRate').textContent = '-';
            document.getElementById('avgGenerationTime').textContent = '-';
            document.getElementById('maxGenerationTime').textContent = '-';
            
            // Show loading for test case stats
            document.getElementById('totalTestCases').textContent = '-';
            document.getElementById('jiraTestCases').textContent = '-';
            document.getElementById('azureTestCases').textContent = '-';
            document.getElementById('imageTestCases').textContent = '-';
            document.getElementById('urlTestCases').textContent = '-';

            
            // Show loading for charts
            const chartContainers = document.querySelectorAll('.chart-container');
            chartContainers.forEach(container => {
                const canvas = container.querySelector('canvas');
                const placeholder = container.querySelector('.chart-placeholder');
                const loadingPlaceholder = container.querySelector('.loading-placeholder');
                const contentDiv = container.querySelector('#recentErrors, #recentActivity');
                
                if (canvas) {
                    canvas.style.display = 'none';
                }
                if (placeholder) {
                    placeholder.style.display = 'none';
                }
                if (loadingPlaceholder) {
                    loadingPlaceholder.style.display = 'flex';
                }
                if (contentDiv) {
                    contentDiv.innerHTML = '<div class="loading-message"><i class="bi bi-hourglass-split"></i> Loading...</div>';
                }
            });
            
            // Show loading for error stats
            document.getElementById('totalErrors').textContent = '-';
            document.getElementById('warningErrors').textContent = '-';
            document.getElementById('criticalErrors').textContent = '-';
            document.getElementById('infoErrors').textContent = '-';
            document.getElementById('exceptionErrors').textContent = '-';
            document.getElementById('messageErrors').textContent = '-';
        }

        // Scroll to top on page refresh
        window.addEventListener('beforeunload', function() {
            window.scrollTo(0, 0);
        });
        
        // Also scroll to top when page loads
        window.addEventListener('load', function() {
            window.scrollTo(0, 0);
        });
        


        function initializeDateRangePicker() {
            $('input[name="daterange"]').daterangepicker({
                opens: 'left',
                startDate: moment().subtract(30, 'days'),
                endDate: moment(),
                ranges: {
                   'Today': [moment(), moment()],
                   'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                   'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                   'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                   'This Month': [moment().startOf('month'), moment().endOf('month')],
                   'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                }
            }, function(start, end, label) {
                console.log("A new date selection was made: " + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD'));
                selectedStartDate = start.toDate();
                selectedEndDate = end.toDate();
                // Auto-reload analytics when date range changes
                loadAnalytics();
            });
            
            // Set initial dates
            const initialRange = $('input[name="daterange"]').data('daterangepicker');
            if (initialRange) {
                selectedStartDate = initialRange.startDate.toDate();
                selectedEndDate = initialRange.endDate.toDate();
            }
            
            // Add click event listener to calendar icon
            document.getElementById('calendarIcon').addEventListener('click', function() {
                $('input[name="daterange"]').data('daterangepicker').toggle();
            });
        }

        function initializeSmartSearch() {
            const searchInput = document.getElementById('sourceTypeSearch');
            const dropdown = document.getElementById('sourceTypeDropdown');
            const hiddenInput = document.getElementById('sourceType');
            const clearBtn = document.getElementById('clearSourceBtn');
            const options = dropdown.querySelectorAll('.smart-search-option');
            
            let selectedIndex = -1;
            let filteredOptions = Array.from(options);
            
            // Show dropdown on focus
            searchInput.addEventListener('focus', function() {
                showDropdown();
                filterOptions();
            });
            
            // Handle input changes
            searchInput.addEventListener('input', function() {
                const currentValue = this.value;
                const hiddenValue = hiddenInput.value;
                
                // If input is empty, clear everything and show all options
                if (currentValue === '') {
                    clearBtn.style.display = 'none';
                    hiddenInput.value = '';
                    options.forEach(opt => opt.classList.remove('selected'));
                    
                    // Show dropdown with all options when field is empty and focused
                    if (document.activeElement === searchInput) {
                        showDropdown();
                        filterOptions(); // This will show all options since search term is empty
                    }
                    
                    // Trigger analytics reload to show all data
                    loadAnalytics();
                    return;
                }
                
                // If user is typing and there was a previous selection, clear it
                if (hiddenValue && currentValue !== getSelectedOptionText()) {
                    clearSelection();
                }
                
                filterOptions();
                selectedIndex = -1;
            });
            
            // Handle keyboard navigation
            searchInput.addEventListener('keydown', function(e) {
                switch(e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        navigateOptions(1);
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        navigateOptions(-1);
                        break;
                    case 'Enter':
                        e.preventDefault();
                        selectOption();
                        break;
                    case 'Escape':
                        hideDropdown();
                        break;
                }
            });
            
            // Handle option clicks
            options.forEach(option => {
                option.addEventListener('click', function() {
                    selectOptionElement(this);
                });
            });
            
            // Handle clear button
            clearBtn.addEventListener('click', function() {
                clearSelection();
            });
            
            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target) && !clearBtn.contains(e.target)) {
                    hideDropdown();
                }
            });
            
            function showDropdown() {
                dropdown.style.display = 'block';
                filterOptions();
            }
            
            function hideDropdown() {
                dropdown.style.display = 'none';
                selectedIndex = -1;
                clearHighlights();
            }
            
            function filterOptions() {
                const searchTerm = searchInput.value.toLowerCase();
                
                options.forEach(option => {
                    const text = option.textContent.toLowerCase();
                    if (text.includes(searchTerm)) {
                        option.classList.remove('hidden');
                    } else {
                        option.classList.add('hidden');
                    }
                });
                
                filteredOptions = Array.from(options).filter(option => !option.classList.contains('hidden'));
            }
            
            function navigateOptions(direction) {
                if (filteredOptions.length === 0) return;
                
                clearHighlights();
                
                selectedIndex += direction;
                if (selectedIndex >= filteredOptions.length) {
                    selectedIndex = 0;
                } else if (selectedIndex < 0) {
                    selectedIndex = filteredOptions.length - 1;
                }
                
                const selectedOption = filteredOptions[selectedIndex];
                selectedOption.classList.add('highlighted');
                
                // Scroll to selected option
                selectedOption.scrollIntoView({ block: 'nearest' });
            }
            
            function selectOption() {
                if (filteredOptions.length === 1) {
                    // Auto-select if only one option is visible
                    selectOptionElement(filteredOptions[0]);
                } else if (selectedIndex >= 0 && selectedIndex < filteredOptions.length) {
                    selectOptionElement(filteredOptions[selectedIndex]);
                }
            }
            
            function selectOptionElement(option) {
                const value = option.getAttribute('data-value');
                const text = option.textContent.trim();
                
                searchInput.value = text;
                hiddenInput.value = value;
                
                // Show clear button
                clearBtn.style.display = 'block';
                
                // Update selected state
                options.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                
                hideDropdown();
                
                // Trigger analytics reload
                console.log('Source type filter changed to:', value);
                loadAnalytics();
            }
            
            function clearSelection() {
                searchInput.value = '';
                hiddenInput.value = '';
                clearBtn.style.display = 'none';
                
                // Clear selected state
                options.forEach(opt => opt.classList.remove('selected'));
                
                // Hide dropdown if open
                hideDropdown();
                
                // Trigger analytics reload
                console.log('Source type filter cleared');
                loadAnalytics();
            }
            
            function clearHighlights() {
                options.forEach(option => {
                    option.classList.remove('highlighted');
                });
            }
            
            function getSelectedOptionText() {
                const selectedOption = options.find(opt => opt.classList.contains('selected'));
                return selectedOption ? selectedOption.textContent.trim() : '';
            }
        }

        async function loadAnalytics() {
            // Prevent multiple simultaneous calls
            const loadButton = document.querySelector('button[onclick="loadAnalytics()"]');
            if (loadButton.disabled) {
                console.log('Analytics loading already in progress, skipping...');
                return;
            }
            
            // Get dates from daterangepicker
            const daterangePicker = $('input[name="daterange"]').data('daterangepicker');
            let startDate = '';
            let endDate = '';
            
            if (daterangePicker) {
                startDate = daterangePicker.startDate.format('YYYY-MM-DD');
                endDate = daterangePicker.endDate.format('YYYY-MM-DD');
            } else if (selectedStartDate && selectedEndDate) {
                // Fallback to selected dates if daterangepicker not initialized
                startDate = selectedStartDate.toISOString().split('T')[0];
                endDate = selectedEndDate.toISOString().split('T')[0];
            }
            
            const sourceType = document.getElementById('sourceType').value;

            console.log('Loading analytics with filters:', { startDate, endDate, sourceType });
            console.log('Source type filter value:', sourceType);
            console.log('Source type element:', document.getElementById('sourceType'));

            // Show loading state for all sections
            showLoadingState();

            // Set button to loading state immediately
            const originalText = loadButton.innerHTML;
            const originalDisabled = loadButton.disabled;
            loadButton.innerHTML = '<i class="bi bi-hourglass-split"></i> Loading...';
            loadButton.disabled = true;
            // Keep the button green during loading
            loadButton.classList.add('btn-loading');
            loadButton.classList.remove('btn-secondary');
            
            // Add a minimum loading time to make the loading state visible
            const startTime = Date.now();
            const minLoadingTime = 800; // 800ms minimum loading time

            try {
                // Build summary URL with all filters
                let summaryUrl = `/api/analytics/summary?start_date=${startDate}&end_date=${endDate}`;
                if (sourceType) summaryUrl += `&source_type=${sourceType}`;
                
                console.log('Fetching summary from:', summaryUrl);
                
                const summaryResponse = await fetch(summaryUrl, {
                    headers: getAuthHeaders()
                });
                if (!summaryResponse.ok) {
                    throw new Error(`Summary API failed: ${summaryResponse.status} ${summaryResponse.statusText}`);
                }
                
                const summaryData = await summaryResponse.json();
                console.log('Summary data received:', summaryData);
                
                if (summaryData.success) {
                    updateSummaryStats(summaryData.data);
                    updateCharts(summaryData.data);
                    
                    // Check if we have any data
                    const hasData = summaryData.data.total_sessions > 0 || 
                                   summaryData.data.generate_clicks > 0 || 
                                   summaryData.data.successful_generations > 0;
                    
                    if (!hasData) {
                        showMessage('No analytics data found for the selected filters. Try selecting a different period or filters.', 'info');
                    }
                } else {
                    console.error('Summary API returned error:', summaryData.error);
                    showError('Failed to load summary data: ' + (summaryData.error || 'Unknown error'));
                }

                // Load detailed analytics with all filters (admin only)
                if (isAdmin) {
                    let detailedUrl = `/api/analytics/detailed?start_date=${startDate}&end_date=${endDate}`;
                    if (sourceType) detailedUrl += `&source_type=${sourceType}`;
                    
                    console.log('Fetching detailed analytics from:', detailedUrl);
                    console.log('Auth headers for detailed:', getAuthHeaders());
                    try {
                        const detailedResponse = await fetch(detailedUrl, {
                            headers: getAuthHeaders()
                        });
                        console.log('Detailed analytics response status:', detailedResponse.status);
                        
                        if (detailedResponse.status === 403) {
                            console.warn('Detailed analytics forbidden for current user');
                            updateRecentActivityFallback();
                        } else if (!detailedResponse.ok) {
                            throw new Error(`Detailed API failed: ${detailedResponse.status} ${detailedResponse.statusText}`);
                        } else {
                            const detailedData = await detailedResponse.json();
                            console.log('Detailed data received:', detailedData);
                            if (detailedData.success) {
                                updateRecentActivity(detailedData.data);
                            } else {
                                console.warn('Detailed API returned error, showing fallback activity');
                                // Show fallback recent activity from summary data
                                updateRecentActivityFallback();
                            }
                        }
                    } catch (e) {
                        console.warn('Detailed analytics load skipped:', e.message);
                        // Show fallback when detailed analytics fails
                        updateRecentActivityFallback();
                    }
                } else {
                    // For regular users, show fallback recent activity
                    console.log('Regular user - showing fallback recent activity');
                    updateRecentActivityFallback();
                }

                // Load error analytics (admin only)
                if (isAdmin) {
                    let errorUrl = `/api/analytics/errors?start_date=${startDate}&end_date=${endDate}`;
                    if (sourceType) errorUrl += `&source_type=${sourceType}`;
                    
                    console.log('Fetching error analytics from:', errorUrl);
                    console.log('Auth headers:', getAuthHeaders());
                    try {
                        const errorResponse = await fetch(errorUrl, {
                            headers: getAuthHeaders()
                        });
                        console.log('Error analytics response status:', errorResponse.status);
                        console.log('Error analytics response headers:', errorResponse.headers);
                        
                        if (errorResponse.status === 403) {
                            console.warn('Error analytics forbidden for current user');
                            updateErrorAnalyticsNoData();
                        } else if (errorResponse.ok) {
                            const errorData = await errorResponse.json();
                            console.log('Error data received:', errorData);
                            if (errorData.success) {
                                updateErrorStats(errorData.data);
                                updateErrorCharts(errorData.data);
                            } else {
                                console.warn('Error API returned error, showing no data');
                                updateErrorAnalyticsNoData();
                            }
                        } else {
                            console.warn('Error analytics failed with status:', errorResponse.status);
                            updateErrorAnalyticsNoData();
                        }
                    } catch (e) {
                        console.warn('Error analytics load skipped:', e.message);
                        updateErrorAnalyticsNoData();
                    }
                }

            } catch (error) {
                console.error('Error loading analytics:', error);
                showError('Failed to load analytics data: ' + error.message);
            } finally {
                // Ensure minimum loading time
                const elapsedTime = Date.now() - startTime;
                if (elapsedTime < minLoadingTime) {
                    await new Promise(resolve => setTimeout(resolve, minLoadingTime - elapsedTime));
                }
                
                // Restore button state
                loadButton.innerHTML = originalText;
                loadButton.disabled = originalDisabled;
                loadButton.classList.remove('btn-loading');
                loadButton.classList.add('btn-primary');
            }
        }

        function updateSummaryStats(data) {
            // Normalize summary object shape and guard against undefined values
            const summary = (data && typeof data === 'object') ? (data.summary || data) : {};
            const timing = summary.generation_timing || {};

            const toNumber = (val, fallback = 0) => {
                const n = Number(val);
                return Number.isFinite(n) ? n : fallback;
            };
            const formatInt = (val) => toNumber(val, 0).toLocaleString();
            const formatFixed = (val, d = 1) => toNumber(val, 0).toFixed(d);

            // Hide Total Sessions card for non-admin users
            const totalSessionsCard = document.getElementById('totalSessions').closest('.col-md-2');
            if (totalSessionsCard) {
                if (isAdmin) {
                    totalSessionsCard.style.display = '';
                } else {
                    totalSessionsCard.style.display = 'none';
                }
            }

            document.getElementById('totalSessions').textContent = formatInt(summary.total_sessions);
            document.getElementById('generateClicks').textContent = formatInt(summary.generate_clicks);
            document.getElementById('successfulGenerations').textContent = formatInt(summary.successful_generations);
            document.getElementById('successRate').textContent = Math.min(toNumber(summary.success_rate, 0), 100).toFixed(1);
            
            // Update timing stats
            if (timing && (timing.avg_generation_time !== undefined || timing.max_generation_time !== undefined)) {
                document.getElementById('avgGenerationTime').textContent = formatFixed(timing.avg_generation_time, 1);
                document.getElementById('maxGenerationTime').textContent = formatFixed(timing.max_generation_time, 1);
            } else {
                document.getElementById('avgGenerationTime').textContent = '-';
                document.getElementById('maxGenerationTime').textContent = '-';
            }
            
            // Update test cases stats
            updateTestCasesStats(summary);
        }
        
        function updateTestCasesStats(data) {
            // Initialize counters
            let totalTestCases = 0;
            let jiraTestCases = 0;
            let azureTestCases = 0;
            let imageTestCases = 0;
            let urlTestCases = 0;
            
            // Calculate test cases from source type distribution
            const sourceDist = (data && data.source_type_distribution) ? data.source_type_distribution : [];
            if (Array.isArray(sourceDist)) {
                sourceDist.forEach(item => {
                    const sourceType = item._id ? item._id.toLowerCase() : '';
                    const count = item.count || 0;
                    
                    totalTestCases += count;
                    
                    switch (sourceType) {
                        case 'jira':
                            jiraTestCases = count;
                            break;
                        case 'azure':
                            azureTestCases = count;
                            break;
                        case 'image':
                            imageTestCases = count;
                            break;
                        case 'url':
                            urlTestCases = count;
                            break;
                        default:
                            // Skip unknown source types since we only support 4 types
                            break;
                    }
                });
            }
            
            // Update the UI
            document.getElementById('totalTestCases').textContent = Number(totalTestCases).toLocaleString();
            document.getElementById('jiraTestCases').textContent = Number(jiraTestCases).toLocaleString();
            document.getElementById('azureTestCases').textContent = Number(azureTestCases).toLocaleString();
            document.getElementById('imageTestCases').textContent = Number(imageTestCases).toLocaleString();
            document.getElementById('urlTestCases').textContent = Number(urlTestCases).toLocaleString();

        }

        function updateCharts(data) {
            // Source Type Chart
            const sourceTypeCtx = document.getElementById('sourceTypeChart');
            const sourceTypePlaceholder = document.getElementById('sourceTypePlaceholder');
            
            if (sourceTypeChart && typeof sourceTypeChart.destroy === 'function') sourceTypeChart.destroy();
            
            if (data.source_type_distribution && data.source_type_distribution.length > 0) {
                sourceTypeCtx.style.display = 'block';
                sourceTypePlaceholder.style.display = 'none';
                const loadingPlaceholder = document.getElementById('sourceTypeLoading');
                if (loadingPlaceholder) loadingPlaceholder.style.display = 'none';
                sourceTypeCtx.closest('.chart-container').classList.remove('compact');
                
                sourceTypeChart = new Chart(sourceTypeCtx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: data.source_type_distribution.map(item => {
                        const sourceType = item._id;
                        if (!sourceType || sourceType === 'null' || sourceType === '') {
                            return 'Unknown';
                        }
                        // Capitalize and format source type names
                        return sourceType.charAt(0).toUpperCase() + sourceType.slice(1).toLowerCase();
                    }),
                    datasets: [{
                        data: data.source_type_distribution.map(item => item.count),
                            backgroundColor: ['#4CAA72', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            onHover: function(e, legendItem, legend) {
                                const target = e.native?.target || e.native?.dom || e.native;
                                if (target && target.style) target.style.cursor = 'pointer';
                            },
                            onLeave: function(e, legendItem, legend) {
                                const target = e.native?.target || e.native?.dom || e.native;
                                if (target && target.style) target.style.cursor = 'default';
                            }
                        }
                    }
                }
            });
            } else {
                sourceTypeCtx.style.display = 'none';
                sourceTypePlaceholder.style.display = 'flex';
                const loadingPlaceholder = document.getElementById('sourceTypeLoading');
                if (loadingPlaceholder) loadingPlaceholder.style.display = 'none';
                sourceTypeCtx.closest('.chart-container').classList.add('compact');
            }

            // Test Case Type Chart
            const testCaseTypeCtx = document.getElementById('testCaseTypeChart');
            const testCaseTypePlaceholder = document.getElementById('testCaseTypePlaceholder');
            
            if (testCaseTypeChart && typeof testCaseTypeChart.destroy === 'function') testCaseTypeChart.destroy();
            
            if (data.test_case_type_distribution && data.test_case_type_distribution.length > 0) {
                testCaseTypeCtx.style.display = 'block';
                testCaseTypePlaceholder.style.display = 'none';
                const loadingPlaceholder = document.getElementById('testCaseTypeLoading');
                if (loadingPlaceholder) loadingPlaceholder.style.display = 'none';
                testCaseTypeCtx.closest('.chart-container').classList.remove('compact');
                
                // Check if there's only one data point for consistent bar width
                const isSingleBar = data.test_case_type_distribution.length === 1;
                
                testCaseTypeChart = new Chart(testCaseTypeCtx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: data.test_case_type_distribution.map(item => item._id || 'Unknown'),
                    datasets: [{
                        label: 'Usage Count',
                        data: data.test_case_type_distribution.map(item => item.count),
                        backgroundColor: data.test_case_type_distribution.map((item, index) => {
                            const colors = ['#4CAA72', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE'];
                            return colors[index % colors.length];
                        }),
                        borderWidth: 0,
                        borderRadius: 4,
                        borderSkipped: false,
                        // Consistent bar width regardless of data points
                        maxBarThickness: 40,
                        barPercentage: 0.8,
                        categoryPercentage: 0.8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            } else {
                testCaseTypeCtx.style.display = 'none';
                testCaseTypePlaceholder.style.display = 'flex';
                const loadingPlaceholder = document.getElementById('testCaseTypeLoading');
                if (loadingPlaceholder) loadingPlaceholder.style.display = 'none';
                testCaseTypeCtx.closest('.chart-container').classList.add('compact');
            }

            // Daily Activity Chart
            const dailyActivityCtx = document.getElementById('dailyActivityChart');
            const dailyActivityPlaceholder = document.getElementById('dailyActivityPlaceholder');
            const dailyActivityContainer = dailyActivityCtx.closest('.chart-container');
            
            if (dailyActivityChart && typeof dailyActivityChart.destroy === 'function') dailyActivityChart.destroy();
            
            if (data.daily_activity && data.daily_activity.length > 0) {
                dailyActivityCtx.style.display = 'block';
                dailyActivityPlaceholder.style.display = 'none';
                dailyActivityContainer.classList.remove('compact');
                
                dailyActivityChart = new Chart(dailyActivityCtx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: data.daily_activity.map(item => `${item._id.month}/${item._id.day}`),
                    datasets: [{
                        label: 'Events',
                        data: data.daily_activity.map(item => item.events),
                        borderColor: '#4CAA72',
                            backgroundColor: 'rgba(76, 170, 114, 0.2)',
                            tension: 0.4,
                            fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            } else {
                dailyActivityCtx.style.display = 'none';
                dailyActivityPlaceholder.style.display = 'flex';
                dailyActivityContainer.classList.add('compact');
            }
            
            // Timing by Source Type Chart
            const timingBySourceCtx = document.getElementById('timingBySourceChart');
            const timingBySourcePlaceholder = document.getElementById('timingBySourcePlaceholder');
            const timingBySourceContainer = timingBySourceCtx.closest('.chart-container');
            
            if (timingBySourceChart && typeof timingBySourceChart.destroy === 'function') timingBySourceChart.destroy();
            
            if (data.timing_by_source && data.timing_by_source.length > 0) {
                timingBySourceCtx.style.display = 'block';
                timingBySourcePlaceholder.style.display = 'none';
                timingBySourceContainer.classList.remove('compact');
                
                timingBySourceChart = new Chart(timingBySourceCtx.getContext('2d'), {
                     type: 'bar',
                     data: {
                         labels: data.timing_by_source.map(item => {
                             const sourceType = item._id;
                             if (!sourceType || sourceType === 'null' || sourceType === '') {
                                 return 'Unknown';
                             }
                             // Capitalize and format source type names
                             return sourceType.charAt(0).toUpperCase() + sourceType.slice(1).toLowerCase();
                         }),
                         datasets: [{
                             label: 'Average Generation Time (seconds)',
                             data: data.timing_by_source.map(item => item.avg_generation_time.toFixed(1)),
                            backgroundColor: data.timing_by_source.map((item, index) => {
                                const colors = ['#4CAA72', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE'];
                                return colors[index % colors.length];
                            })
                         }]
                     },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Seconds'
                                }
                            }
                        }
                    }
                });
            } else {
                timingBySourceCtx.style.display = 'none';
                timingBySourcePlaceholder.style.display = 'flex';
                timingBySourceContainer.classList.add('compact');
            }
            
            // Timing by Item Count Chart
            const timingByItemsCtx = document.getElementById('timingByItemsChart');
            const timingByItemsPlaceholder = document.getElementById('timingByItemsPlaceholder');
            const timingByItemsContainer = timingByItemsCtx.closest('.chart-container');
            
            if (timingByItemsChart && typeof timingByItemsChart.destroy === 'function') timingByItemsChart.destroy();
            
            if (data.timing_by_items && data.timing_by_items.length > 0) {
                timingByItemsCtx.style.display = 'block';
                timingByItemsPlaceholder.style.display = 'none';
                timingByItemsContainer.classList.remove('compact');
                
                timingByItemsChart = new Chart(timingByItemsCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: data.timing_by_items.map(item => item._id.item_range),
                        datasets: [{
                            label: 'Average Generation Time (seconds)',
                            data: data.timing_by_items.map(item => item.avg_generation_time.toFixed(1)),
                            borderColor: '#4CAA72',
                            backgroundColor: 'rgba(76, 170, 114, 0.2)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Average Time per Item (seconds)',
                            data: data.timing_by_items.map(item => item.avg_time_per_item ? item.avg_time_per_item.toFixed(1) : 0),
                            borderColor: '#FF6B6B',
                            backgroundColor: 'rgba(255, 107, 107, 0.2)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Seconds'
                                }
                            }
                        }
                    }
                });
            } else {
                timingByItemsCtx.style.display = 'none';
                timingByItemsPlaceholder.style.display = 'flex';
                timingByItemsContainer.classList.add('compact');
            }
        }

        function updateErrorAnalyticsNoData() {
            // Show no data for error analytics
            document.getElementById('totalErrors').textContent = '0';
            document.getElementById('warningErrors').textContent = '0';
            document.getElementById('criticalErrors').textContent = '0';
            document.getElementById('infoErrors').textContent = '0';
            document.getElementById('exceptionErrors').textContent = '0';
            document.getElementById('messageErrors').textContent = '0';
            
            // Show no data placeholders for charts
            document.getElementById('errorLevelPlaceholder').style.display = 'flex';
            document.getElementById('errorTypePlaceholder').style.display = 'flex';
            document.getElementById('recentErrors').innerHTML = '<div class="no-data-message"><i class="bi bi-check-circle"></i> No recent errors</div>';
            
            // Hide chart canvases
            const errorLevelChart = document.getElementById('errorLevelChart');
            const errorTypeChart = document.getElementById('errorTypeChart');
            if (errorLevelChart) errorLevelChart.style.display = 'none';
            if (errorTypeChart) errorTypeChart.style.display = 'none';
        }

        function updateRecentActivityFallback() {
            const container = document.getElementById('recentActivity');
            const recentActivityContainer = container.closest('.chart-container');
            
            // Try to load recent test cases instead of analytics events
            loadRecentTestCases(container, recentActivityContainer);
        }
        
        async function loadRecentTestCases(container, recentActivityContainer) {
            try {
                console.log('Loading recent test cases...');
                const response = await fetch('/api/test-cases/recent', {
                    headers: getAuthHeaders()
                });
                
                console.log('Test cases API response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Test cases API response data:', data);
                    
                    if (data.success && data.test_cases && data.test_cases.length > 0) {
                        // Show recent test cases
                        recentActivityContainer.classList.remove('compact');
                        const testCasesHtml = data.test_cases.slice(0, 5).map(testCase => {
                            const createdDate = new Date(testCase.created_at).toLocaleString();
                            const sourceType = testCase.source_type || 'Unknown';
                            return `
                                <div class="activity-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="bi bi-check-circle"></i>
                                            <strong>Test Case Generated</strong>
                                            - ${sourceType.charAt(0).toUpperCase() + sourceType.slice(1).toLowerCase()}
                                            ${testCase.item_id ? `(${testCase.item_id})` : ''}
                                        </div>
                                        <small class="text-muted">${createdDate}</small>
                                    </div>
                                </div>
                            `;
                        }).join('');
                        
                        container.innerHTML = testCasesHtml;
                    } else {
                        // No test cases found
                        recentActivityContainer.classList.add('compact');
                        container.innerHTML = `
                            <div class="no-data-message">
                                <i class="bi bi-clock-history"></i> 
                                <div>No recent test cases found</div>
                                <small class="text-muted">Generate your first test case to see activity here</small>
                            </div>
                        `;
                    }
                } else {
                    throw new Error('Failed to fetch recent test cases');
                }
            } catch (error) {
                console.warn('Failed to load recent test cases:', error);
                // Fallback to simple message
                recentActivityContainer.classList.add('compact');
                container.innerHTML = `
                    <div class="no-data-message">
                        <i class="bi bi-clock-history"></i> 
                        <div>Recent activity data not available</div>
                        <small class="text-muted">Try generating some test cases to see activity</small>
                    </div>
                `;
            }
        }

        function updateRecentActivity(events) {
            const container = document.getElementById('recentActivity');
            const recentActivityContainer = container.closest('.chart-container');
            
            // Filter out unwanted events
            const filteredEvents = events.filter(event => event.event_type !== 'share_request_received');
            
            if (filteredEvents.length === 0) {
                container.innerHTML = '<div class="no-data-message"><i class="bi bi-clock-history"></i> No recent activity found</div>';
                recentActivityContainer.classList.add('compact');
                return;
            }

            recentActivityContainer.classList.remove('compact');

            const activityHtml = filteredEvents.slice(0, 5).map(event => {
                const timestamp = new Date(event.timestamp).toLocaleString();
                const eventIcon = getEventIcon(event.event_type);
                const eventLabel = getEventLabel(event.event_type);
                
                // Add timing information for generation events
                let timingInfo = '';
                if (event.event_type === 'test_case_generated' && event.event_data && event.event_data.generation_duration_seconds) {
                    timingInfo = `<br><small class="text-info">⏱️ Generation time: ${event.event_data.generation_duration_seconds.toFixed(1)}s (${event.item_count || 0} items)</small>`;
                } else if (event.event_type === 'generation_completed' && event.event_data && event.event_data.total_generation_time_seconds) {
                    timingInfo = `<br><small class="text-info">⏱️ Total time: ${event.event_data.total_generation_time_seconds.toFixed(1)}s</small>`;
                }
                
                return `
                    <div class="activity-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                                                 <i class="bi ${eventIcon}"></i>
                                 <strong>${eventLabel}</strong>
                                 ${event.source_type && event.source_type !== 'null' && event.source_type !== '' ? 
                                     `- ${event.source_type.charAt(0).toUpperCase() + event.source_type.slice(1).toLowerCase()}` : ''}
                                ${event.test_case_types && event.test_case_types.length > 0 ? 
                                    `(${event.test_case_types.join(', ')})` : ''}
                                ${timingInfo}
                            </div>
                            <small class="text-muted">${timestamp}</small>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = activityHtml;
        }

        function getEventIcon(eventType) {
            const icons = {
                'analytics_viewed': 'bi-graph-up',
                'generate_button_click': 'bi-play-circle',
                'test_case_generated': 'bi-check-circle',
                'source_type_changed': 'bi-arrow-repeat',
                'test_case_type_toggled': 'bi-check-square',
                'item_selected': 'bi-plus-circle',
                'item_removed': 'bi-dash-circle',
                'form_submitted': 'bi-send',
                'share_attempted': 'bi-share',
                'share_created': 'bi-share-fill',
                'share_url_copied': 'bi-clipboard-check',
                'copy_table_attempted': 'bi-table',
                'copy_url_attempted': 'bi-link-45deg',
                'copy_url_successful': 'bi-link-45deg',
                'excel_download_clicked': 'bi-file-earmark-excel',
                'txt_download_clicked': 'bi-file-text',
                'file_download_attempted': 'bi-download',
                'file_download_successful': 'bi-download',
                'status_changed': 'bi-arrow-repeat',
                'shared_page_visited': 'bi-eye',
                'share_created_successfully': 'bi-share-fill',
                'generation_completed': 'bi-check-circle-fill'
            };
            return icons[eventType] || 'bi-circle';
        }

        function getEventLabel(eventType) {
            const labels = {
                'analytics_viewed': 'Analytics Viewed',
                'generate_button_click': 'Generate Button Clicked',
                'test_case_generated': 'Test Cases Generated',
                'source_type_changed': 'Source Type Changed',
                'test_case_type_toggled': 'Test Case Type Toggled',
                'item_selected': 'Item Selected',
                'item_removed': 'Item Removed',
                'form_submitted': 'Form Submitted',
                'share_attempted': 'Share Attempted',
                'share_created': 'Share Created',
                'share_url_copied': 'Share URL Copied',
                'copy_table_attempted': 'Copy Table Attempted',
                'copy_url_attempted': 'Copy URL Attempted',
                'copy_url_successful': 'Copy URL Successful',
                'excel_download_clicked': 'Excel Download Clicked',
                'txt_download_clicked': 'TXT Download Clicked',
                'file_download_attempted': 'File Download Attempted',
                'file_download_successful': 'File Download Successful',
                'status_changed': 'Status Changed',
                'shared_page_visited': 'Shared Page Visited',
                'share_created_successfully': 'Share Created Successfully',
                'generation_completed': 'Generation Completed'
            };
            return labels[eventType] || eventType;
        }

        function showError(message) {
            const container = document.getElementById('recentActivity');
            container.innerHTML = `<div class="alert alert-danger">${message}</div>`;
        }

        function showMessage(message, type = 'info') {
            const container = document.getElementById('recentActivity');
            const alertClass = type === 'info' ? 'alert-info' : type === 'success' ? 'alert-success' : 'alert-warning';
            container.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
        }

        function updateErrorStats(data) {
            // Filter out debug entries from the data
            const filteredLevelData = data.errors_by_level ? data.errors_by_level.filter(level => level._id !== 'debug') : [];
            const filteredTypeData = data.errors_by_type ? data.errors_by_type.filter(type => type._id !== 'debug') : [];
            
            // Calculate total errors excluding debug
            const totalErrorsExcludingDebug = filteredLevelData.reduce((sum, level) => sum + level.count, 0);
            
            // Update error summary stats
            document.getElementById('totalErrors').textContent = totalErrorsExcludingDebug.toLocaleString();
            
            // Update error counts by level
            let warningCount = 0, criticalCount = 0, infoCount = 0, exceptionCount = 0, messageCount = 0;
            
            if (filteredLevelData) {
                filteredLevelData.forEach(level => {
                    switch (level._id) {
                        case 'warning':
                            warningCount = level.count;
                            break;
                        case 'error':
                        case 'critical':
                            criticalCount += level.count;
                            break;
                        case 'info':
                            infoCount = level.count;
                            break;
                    }
                });
            }
            
            if (filteredTypeData) {
                filteredTypeData.forEach(type => {
                    switch (type._id) {
                        case 'exception':
                            exceptionCount = type.count;
                            break;
                        case 'message':
                            messageCount = type.count;
                            break;
                    }
                });
            }
            
            document.getElementById('warningErrors').textContent = warningCount.toLocaleString();
            document.getElementById('criticalErrors').textContent = criticalCount.toLocaleString();
            document.getElementById('infoErrors').textContent = infoCount.toLocaleString();
            document.getElementById('exceptionErrors').textContent = exceptionCount.toLocaleString();
            document.getElementById('messageErrors').textContent = messageCount.toLocaleString();
        }

        function updateErrorCharts(data) {
            try {
                // Update error level chart
                if (data.errors_by_level && data.errors_by_level.length > 0) {
                    updateErrorLevelChart(data.errors_by_level);
                } else {
                    document.getElementById('errorLevelPlaceholder').style.display = 'block';
                    const canvas = document.getElementById('errorLevelChart');
                    if (canvas) canvas.style.display = 'none';
                }
                
                // Update error type chart
                if (data.errors_by_type && data.errors_by_type.length > 0) {
                    updateErrorTypeChart(data.errors_by_type);
                } else {
                    document.getElementById('errorTypePlaceholder').style.display = 'block';
                    const canvas = document.getElementById('errorTypeChart');
                    if (canvas) canvas.style.display = 'none';
                }
                
                // Update recent errors list
                if (data.recent_errors && data.recent_errors.length > 0) {
                    updateRecentErrorsList(data.recent_errors);
                } else {
                    document.getElementById('recentErrors').innerHTML = '<div class="no-data-message"><i class="bi bi-check-circle"></i> No recent errors</div>';
                }
            } catch (error) {
                console.error('Error updating error charts:', error);
                // Show a user-friendly message
                const errorLevelPlaceholder = document.getElementById('errorLevelPlaceholder');
                const errorTypePlaceholder = document.getElementById('errorTypePlaceholder');
                const recentErrors = document.getElementById('recentErrors');
                
                if (errorLevelPlaceholder) {
                    errorLevelPlaceholder.style.display = 'block';
                    errorLevelPlaceholder.innerHTML = '<div class="no-data-message"><i class="bi bi-exclamation-triangle"></i> Error loading chart</div>';
                }
                
                if (errorTypePlaceholder) {
                    errorTypePlaceholder.style.display = 'block';
                    errorTypePlaceholder.innerHTML = '<div class="no-data-message"><i class="bi bi-exclamation-triangle"></i> Error loading chart</div>';
                }
                
                if (recentErrors) {
                    recentErrors.innerHTML = '<div class="no-data-message"><i class="bi bi-exclamation-triangle"></i> Error loading recent errors</div>';
                }
            }
        }

        function updateErrorLevelChart(data) {
            try {
                const ctx = document.getElementById('errorLevelChart');
                if (!ctx) return;
                
                ctx.style.display = 'block';
                document.getElementById('errorLevelPlaceholder').style.display = 'none';
                
                // Destroy existing chart if it exists
                if (window.errorLevelChart && typeof window.errorLevelChart.destroy === 'function') {
                    window.errorLevelChart.destroy();
                }
                
                // Filter out debug entries and capitalize first letter
                const filteredData = data.filter(item => item._id !== 'debug');
                const labels = filteredData.map(item => {
                    const label = item._id;
                    return label.charAt(0).toUpperCase() + label.slice(1);
                });
                const values = filteredData.map(item => item.count);
                const colors = ['#dc3545', '#ffc107', '#17a2b8', '#28a745', '#6c757d'];
                
                window.errorLevelChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                onHover: function(e, legendItem, legend) {
                                    const target = e.native?.target || e.native?.dom || e.native;
                                    if (target && target.style) target.style.cursor = 'pointer';
                                },
                                onLeave: function(e, legendItem, legend) {
                                    const target = e.native?.target || e.native?.dom || e.native;
                                    if (target && target.style) target.style.cursor = 'default';
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error updating error level chart:', error);
                // Show placeholder with error message
                const placeholder = document.getElementById('errorLevelPlaceholder');
                if (placeholder) {
                    placeholder.style.display = 'block';
                    placeholder.innerHTML = '<div class="no-data-message"><i class="bi bi-exclamation-triangle"></i> Error loading chart</div>';
                }
                const canvas = document.getElementById('errorLevelChart');
                if (canvas) canvas.style.display = 'none';
            }
        }

        function updateErrorTypeChart(data) {
            try {
                const ctx = document.getElementById('errorTypeChart');
                if (!ctx) return;
                
                ctx.style.display = 'block';
                document.getElementById('errorTypePlaceholder').style.display = 'none';
                
                // Destroy existing chart if it exists
                if (window.errorTypeChart && typeof window.errorTypeChart.destroy === 'function') {
                    window.errorTypeChart.destroy();
                }
                
                // Filter out debug entries and capitalize first letter
                const filteredData = data.filter(item => item._id !== 'debug');
                const labels = filteredData.map(item => {
                    const label = item._id;
                    return label.charAt(0).toUpperCase() + label.slice(1);
                });
                const values = filteredData.map(item => item.count);
                
                // Define different colors for each error type
                const errorTypeColors = {
                    'Exception': 'rgba(220, 53, 69, 0.8)',    // Red for exceptions
                    'Message': 'rgba(255, 193, 7, 0.8)',      // Yellow for messages
                    'Warning': 'rgba(255, 152, 0, 0.8)',      // Orange for warnings
                    'Info': 'rgba(23, 162, 184, 0.8)',        // Teal for info
                    'Error': 'rgba(108, 117, 125, 0.8)'       // Gray for general errors
                };
                
                // Map colors to each error type
                const backgroundColor = labels.map(label => errorTypeColors[label] || 'rgba(108, 117, 125, 0.8)');
                const borderColor = backgroundColor.map(color => color.replace('0.8', '1'));
                
                window.errorTypeChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Error Count',
                            data: values,
                            backgroundColor: backgroundColor,
                            borderColor: borderColor,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error updating error type chart:', error);
                // Show placeholder with error message
                const placeholder = document.getElementById('errorTypePlaceholder');
                if (placeholder) {
                    placeholder.style.display = 'block';
                    placeholder.innerHTML = '<div class="no-data-message"><i class="bi bi-exclamation-triangle"></i> Error loading chart</div>';
                }
                const canvas = document.getElementById('errorTypeChart');
                if (canvas) canvas.style.display = 'none';
            }
        }

        function updateRecentErrorsList(errors) {
            const container = document.getElementById('recentErrors');
            
            // Filter out debug entries
            const filteredErrors = errors.filter(error => error.level !== 'debug');
            
            const errorsHtml = filteredErrors.map(error => {
                const timestamp = new Date(error.timestamp).toLocaleString();
                const levelClass = getErrorLevelClass(error.level);
                const levelIcon = getErrorLevelIcon(error.level);
                
                // Capitalize first letter of error type
                const errorType = error.error_type.charAt(0).toUpperCase() + error.error_type.slice(1);
                
                return `
                    <div class="activity-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi ${levelIcon}"></i>
                                <strong class="${levelClass}">${errorType}</strong>
                                <span class="text-muted">- ${error.message}</span>
                            </div>
                            <small class="text-muted">${timestamp}</small>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = errorsHtml;
        }

        function getErrorLevelClass(level) {
            const classes = {
                'error': 'text-danger',
                'critical': 'text-danger',
                'warning': 'text-warning',
                'info': 'text-info',
                'debug': 'text-muted'
            };
            return classes[level] || 'text-muted';
        }

        function getErrorLevelIcon(level) {
            const icons = {
                'error': 'bi-exclamation-circle',
                'critical': 'bi-x-circle',
                'warning': 'bi-exclamation-triangle',
                'info': 'bi-info-circle',
                'debug': 'bi-bug'
            };
            return icons[level] || 'bi-circle';
        }

        
        // Back to Top Button functionality
        const backToTopButton = document.getElementById('backToTop');
        
        window.addEventListener('scroll', () => {
            if (window.pageYOffset > 300) {
                backToTopButton.classList.add('show');
            } else {
                backToTopButton.classList.remove('show');
            }
        });
        
        backToTopButton.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
            
    </script>
</body>
</html>
